import{Component as e}from"./vader.js";let t=[];class VaderRouter{constructor(e,t){this.routes=[],this.middlewares=[],this.errorMiddlewares=[],this.listeners=[],this.basePath=e}get(e,t){this.routes.push({path:e,handler:t,method:"get"})}use(e){this.middlewares.push(e)}listen(e,t){e||(e=Math.random().toString(36).substring(7)),window.onpopstate=async e=>{let t=window.location.pathname,r=`/${t.split("/")[1]}`;this.checkroute(t)||(t="/404");let s=(new DOMParser).parseFromString(await fetch(r,{cache:"reload"}).then((e=>e.text())),"text/html").documentElement;document.querySelector("#root").innerHTML=s.querySelector("#root").innerHTML,document.title=s.querySelector("title").innerHTML,document.querySelector('script[id="router"]').remove();let n=document.createElement("script");n.id="router",n.innerHTML=s.querySelector('script[id="router"]').innerHTML,n.setAttribute("type","module"),document.body.appendChild(n)},this.listeners.push(e),1===this.listeners.length?this.handleRoute(window.location.pathname):this.listeners.pop(),t&&t()}extractParams(e,t){const r=e.split("/").filter((e=>""!==e)),s=t.split("/").filter((e=>""!==e)),n={};return r.forEach(((e,t)=>{if(e.startsWith(":")){const r=e.slice(1);n[r]=s[t]}else if(e.startsWith("*")){s.slice(t).forEach(((e,t)=>{n[t]=e}))}})),n}extractQueryParams(e){const t=e.split("?")[1];if(!t)return{};const r={};return t.split("&").forEach((e=>{const[t,s]=e.split("=");r[t]=s})),r}checkroute(e){return this.routes.find((t=>{if(t.path===e)return!0;if(""===e&&"/"===t.path)return!0;if(e.includes("?")&&(e=e.split("?")[0]),t.path.includes("*")||t.path.includes(":")){const r=t.path.split("/").filter((e=>""!==e)),s=e.split("/").filter((e=>""!==e));if(r.length!==s.length&&!t.path.endsWith("*"))return!1;for(let e=0;e<r.length;e++){const t=r[e],n=s[e];if(!t.startsWith(":")&&!t.startsWith("*")&&t!==n)return!1}return!0}const r=this.extractParams(t.path,e);return Object.keys(r).length>0}))}handleRoute(r){let s=200,n=r,o=this.checkroute(r);o||(o=window.routes.find((e=>e.url.includes("/404")&&!this.error?(window.history.pushState({},"","/404"),window.dispatchEvent(new Event("popstate")),this.error=!0,!1):!(this.error||!e.url.includes("/404"))||void 0)),s=o?200:404);const i=this.extractQueryParams(n),a=o&&o.path?this.extractParams(o.path,n):{};Object.keys(a).forEach((e=>{a[e]=a[e].split("?")?a[e].split("?")[0]:a[e]}));const l={headers:{},params:a,query:i,path:r,fileUrl:window.location.href.split(window.location.origin)[1],url:window.location.href,method:o?o.method:"get",pause:!1,timestamp:Date.now()};window.$CURRENT_URL=l.path,window.$FULL_URL=window.location.href.replace("#","");const u={status:s,log:e=>{void 0===e?console.log(`${l.path} ${l.method} ${u.status} ${l.timestamp}`):console.table({"Request Path":l.path,"Request Method":o.method,"Response Status":u.status,"Request Timestamp":l.timestamp})},refresh:()=>{this.handleRoute(window.location.pathname)},redirect:e=>{!e.startsWith("/")&&(e=`/${e}`),window.history.pushState({},"",e),window.dispatchEvent(new Event("popstate"))},render:async(t,r,s,n)=>{function isClass(e){return"function"==typeof e&&/^class\s/.test(Function.prototype.toString.call(e))}try{let n=new e;if(isClass(t.default)){let e=new t.default;n.state=e.state,n=e}else{if(t.default.toString().includes("this.key"))throw new Error('Using this.key is not supported in functional components use the attribute key="a value" instead');n.key=t.default.toString().split('key="')[1]?t.default.toString().split('key="')[1].split('"')[0]:null;let e={key:n.key,render:()=>t.default.apply(n,[r,s]),request:r,response:s,params:a,queryParams:i,reset:n.reset.bind(n),onMount:n.onMount.bind(n),useState:null,router:{use:n.router.use.bind(n)},bindMount:n.bindMount.bind(n),memoize:n.memoize.bind(n),createComponent:n.createComponent.bind(n),isChild:!1,useState:n.useState.bind(n),parseStyle:n.parseStyle.bind(n),bind:n.bind.bind(n),useRef:n.useRef.bind(n),useReducer:n.useReducer.bind(n),onMount:n.onMount.bind(n),onUnmount:n.onUnmount.bind(n),hydrate:n.hydrate.bind(n)};n.render=e.render,n=e}if(!document.querySelector("#root"))throw new Error("Root element not found, please add an element with id root");n.reset(),n.components={},n.request=r,n.response=s,n.router.use&&!n.isChild?await new Promise((async e=>{if(isClass(t.default))if(isClass(t.default))switch(await n.router.use(r,s),r.pause){case!0:console.log("pausing",r.pause);let t=setInterval((()=>{r.pause?console.log("still pausing",r.pause):(clearInterval(t),e())}),1e3);break;case!1:e()}else e();else switch(await t.default.apply(n,[r,s]),await n.router.use(r,s),r.pause){case!0:let t=setInterval((()=>{r.pause?console.log("still pausing  request",r.url):(clearInterval(t),e())}),1e3);break;case!1:e()}})):n.router.use&&n.isChild&&console.warn("Router.use() is not supported in child components");const o=await n.render();document.querySelector("#root").innerHTML!==o&&(document.querySelector("#root").innerHTML=o),n.bindMount(),n.onMount()}catch(e){console.error(e)}},setQuery:e=>{let t="";Object.keys(e).forEach(((r,s)=>{t+=`${0===s?"?":"&"}${r}=${e[r]}`}));let r=window.location.hash.split("?")[0];t=t.replace("/","-").replaceAll("/","-"),window.location.hash=`${r}${t}`},send:e=>{document.querySelector("#root").innerHTML=e},json:e=>{const t=document.querySelector("#root");t.innerHTML="";const r=document.createElement("pre");r.textContent=JSON.stringify(e,null,2),t.appendChild(r)}};t.forEach((e=>{e(l,u)})),o&&o.handler(l,u)}}window.VaderRouter=VaderRouter;export default VaderRouter;